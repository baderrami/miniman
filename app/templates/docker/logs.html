{% extends "base.html" %}

{% block title %}Logs for {{ container.name }}{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<style>
    #log-container {
        max-height: 500px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .log-line {
        margin: 0;
        padding: 1px 0;
    }
    .log-timestamp {
        color: #aaa;
        font-size: 0.85em;
        margin-right: 10px;
    }
    .auto-scroll {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Logs for {{ container.name }}</h1>
        <a href="{{ url_for('docker.view_config', id=config.id) }}" class="btn btn-secondary">Back to Configuration</a>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Container Information</h5>
                <span class="badge {% if 'Up' in container.status %}bg-success{% else %}bg-danger{% endif %}" id="container-status">
                    {{ container.status }}
                </span>
            </div>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Container ID</dt>
                <dd class="col-sm-9">{{ container.container_id }}</dd>

                <dt class="col-sm-3">Image</dt>
                <dd class="col-sm-9">{{ container.image }}</dd>

                <dt class="col-sm-3">Created</dt>
                <dd class="col-sm-9">{{ container.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>

                <dt class="col-sm-3">Ports</dt>
                <dd class="col-sm-9">{{ container.get_ports() }}</dd>
            </dl>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Container Logs</h5>
                <div>
                    <button id="clear-logs" class="btn btn-sm btn-outline-secondary">Clear</button>
                    <button id="toggle-streaming" class="btn btn-sm btn-primary">Start Streaming</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="log-container" class="bg-dark text-light p-3 rounded">
                {% if success %}
                    <div id="initial-logs">{{ logs }}</div>
                {% else %}
                    <div class="alert alert-danger">
                        Error retrieving logs: {{ logs }}
                    </div>
                {% endif %}
            </div>
            <div class="form-check auto-scroll">
                <input class="form-check-input" type="checkbox" id="auto-scroll" checked>
                <label class="form-check-label" for="auto-scroll">
                    Auto-scroll to new logs
                </label>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        const logContainer = document.getElementById('log-container');
        const initialLogs = document.getElementById('initial-logs');
        const toggleStreamingBtn = document.getElementById('toggle-streaming');
        const clearLogsBtn = document.getElementById('clear-logs');
        const autoScrollCheckbox = document.getElementById('auto-scroll');
        const containerStatus = document.getElementById('container-status');

        const containerId = '{{ container.container_id }}';
        const roomName = '{{ room_name }}';

        let isStreaming = false;

        // Format timestamp
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString();
        }

        // Scroll to bottom of log container
        function scrollToBottom() {
            if (autoScrollCheckbox.checked) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Add a log line to the container
        function addLogLine(timestamp, text) {
            const lineElement = document.createElement('div');
            lineElement.className = 'log-line';

            if (timestamp) {
                const timestampSpan = document.createElement('span');
                timestampSpan.className = 'log-timestamp';
                timestampSpan.textContent = formatTimestamp(timestamp);
                lineElement.appendChild(timestampSpan);
            }

            const textNode = document.createTextNode(text);
            lineElement.appendChild(textNode);

            logContainer.appendChild(lineElement);
            scrollToBottom();
        }

        // Clear all logs
        clearLogsBtn.addEventListener('click', function() {
            logContainer.innerHTML = '';
        });

        // Toggle streaming
        toggleStreamingBtn.addEventListener('click', function() {
            if (isStreaming) {
                // Stop streaming
                socket.emit('leave', { room: roomName });
                isStreaming = false;
                toggleStreamingBtn.textContent = 'Start Streaming';
                toggleStreamingBtn.classList.remove('btn-danger');
                toggleStreamingBtn.classList.add('btn-primary');
            } else {
                // Start streaming
                if (initialLogs) {
                    // Remove initial logs element once we start streaming
                    initialLogs.remove();
                }

                socket.emit('stream_container_logs', {
                    container_id: containerId,
                    room: roomName
                });

                isStreaming = true;
                toggleStreamingBtn.textContent = 'Stop Streaming';
                toggleStreamingBtn.classList.remove('btn-primary');
                toggleStreamingBtn.classList.add('btn-danger');
            }
        });

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to WebSocket server');
        });

        socket.on('status', function(data) {
            console.log('Status:', data.msg);
        });

        socket.on('docker_log', function(data) {
            if (data.container_id === containerId) {
                addLogLine(data.timestamp, data.line);
            }
        });

        socket.on('docker_log_complete', function(data) {
            if (data.container_id === containerId) {
                addLogLine(data.timestamp, `--- Log streaming ${data.success ? 'completed' : 'failed'} ---`);
                isStreaming = false;
                toggleStreamingBtn.textContent = 'Start Streaming';
                toggleStreamingBtn.classList.remove('btn-danger');
                toggleStreamingBtn.classList.add('btn-primary');
            }
        });

        // Listen for container status changes
        socket.on('container_status_change', function(data) {
            if (data.container_id === containerId) {
                // Update the container status badge
                if (data.status) {
                    containerStatus.textContent = data.status === 'running' ? 'Up' : 'Stopped';
                    containerStatus.className = 'badge ' + (data.status === 'running' ? 'bg-success' : 'bg-danger');
                }

                // Add a log entry about the action
                const actionMessage = data.success 
                    ? `--- Container ${data.action} action successful ---` 
                    : `--- Container ${data.action} action failed: ${data.error || 'Unknown error'} ---`;
                addLogLine(data.timestamp, actionMessage);

                // If container was started or restarted and we're not streaming, start streaming
                if ((data.action === 'start' || data.action === 'restart') && data.success && !isStreaming) {
                    // Delay slightly to allow the container to start up
                    setTimeout(function() {
                        toggleStreamingBtn.click();
                    }, 1000);
                }

                // If container was stopped and we're streaming, stop streaming
                if (data.action === 'stop' && data.success && isStreaming) {
                    toggleStreamingBtn.click();
                }
            }
        });

        // Auto-start streaming if container is running
        if ('{{ container.status }}'.includes('Up')) {
            // Delay slightly to ensure the page is fully loaded
            setTimeout(function() {
                toggleStreamingBtn.click();
            }, 500);
        }
    });
</script>
{% endblock %}
